name: Docker Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      run: |
        docker build -t recon-tor:test .

    - name: Test help command
      run: |
        docker run --rm recon-tor:test --help

    - name: Test invalid invocation (should exit 4)
      run: |
        docker run --rm recon-tor:test -- echo "test" || [ $? -eq 4 ]

    - name: Scan for vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'recon-tor:test'
        format: 'table'
        exit-code: '0'  # Don't fail on vulnerabilities (yet)
        severity: 'CRITICAL,HIGH'

    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD

  shellcheck:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: '.'
        severity: warning
        ignore_paths: '.git .github'

  markdown-lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Lint Markdown files
      uses: DavidAnson/markdownlint-cli2-action@v11
      with:
        globs: '**/*.md'
